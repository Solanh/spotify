<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Script Runner</title>
    <link rel="stylesheet" href="index-styles.css"> <!-- Ensure the correct path to your CSS -->
</head>
<body>

    <button type="button" id="run-button">Run</button>
    <div id="loading-spinner" class="spinner" style="display: none;">Loading...</div> <!-- Loading spinner -->

    <script>
        // Handle button click
        document.getElementById('run-button').addEventListener('click', function () {
            // Show the loading spinner
            document.getElementById('loading-spinner').style.display = 'block';

            // Start the login process by redirecting to the Flask login route
            window.location.href = 'https://nameless-ocean-47665-871e4574a92b.herokuapp.com/login';
        });

        // Check if there's a query parameter indicating a callback
        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                // If there's a 'code' param, send it to the Flask backend for token exchange
                fetch('https://nameless-ocean-47665-871e4574a92b.herokuapp.com/callback?code=' + code, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                    } else if (data.error) {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('There was an error processing your request. ' + error.message);
                })
                .finally(() => {
                    // Hide the loading spinner
                    document.getElementById('loading-spinner').style.display = 'none';
                });
            } else {
                // No 'code', no callback, so no need to do anything
                document.getElementById('loading-spinner').style.display = 'none';
            }
        };
    </script>

</body>
</html>
